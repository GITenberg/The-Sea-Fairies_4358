sudo: required
dist: trusty
language: ruby

before_install:
- gem install asciidoctor -v 1.5.2
- gem install tilt
- sudo pip install git+https://github.com/gitenberg-dev/gitberg
- sudo pip install git+https://github.com/gitenberg-dev/pg-epubmaker
script:
- VERSION=`ruby -e "require 'yaml'; meta = YAML.load_file('metadata.yaml'); puts meta['_version'];"`
- git clone https://github.com/gitenberg-dev/asciidoctor-htmlbook.git
- sudo pip install -r asciidoctor-htmlbook/gitberg-machine/requirements.txt

- /usr/bin/python -c "from gitenberg import travis; travis.build_epub()"
- ebook-convert book.epub book.mobi
- xvfb-run ebook-convert book.epub book.pdf
notifications:
  webhooks:
    urls:
      - https://unglue.it/api/travisci/webhook
    on_success: always
    on_failure: never
    on_start: never
deploy:
  skip_cleanup: true
  provider: releases
  api_key:
    secure: prepVGoumi/pS1/r0GkGKoNdFRGmCNs2X9f+V2FhLy2G4MliSt5KDLK14oSqo3WECzL+rsQwTdEHq+S6UkGmypKfwGBZxNrHVOhc6nu4iYW+LWHWq6CU+AbiKw63ZwjyIsOvQI1ARhRAtRUgxqS88aKPmWi7i5s+bK/hfOMKE4TaWAyc7Pfg7srx6zSzgQbANZmgTQBDgByNkSrWdSJgrzXLLWuo7+WcX5dQij+b3A7qoN5UWK86ecPIL5AjYnnhO3lNFsn0lhiSXHktr3KkY5B3ZHwHpWB2YZ3GzkrOCRH5fjscSkAlsJ/9IJZBeqZDt8HTsPyAB375rZiq/Wx9uY2lUPk9rInL3Xe0Tb/HJX9z4LYpIdvjhjnucFqzs/8nF3zXXcITQJUgYkd3m09ntJvgTsSSYAUIVAJW8ROfl9zENgaSIKeGZAFXOHjDzXv8ubT5J4Vn5lJhhzDDUk1gf8kj938oI0+QAh7lOviaaIlvzOCEzfrsPkWIc9ewLfIuR9CQbKzh+179lTKclwZtEkwqez+QbnN8j0tAXKzqiSAfOirBtCacgmOuTXOeHtHm3yTmzzx459qWXTmO+8bqf0CAf70v5/56ykB3Ev+LZp/7Y/N5kll2MZusVQ70Ebq0rLGOXKMTPL+S6EqchQo00QixX5+dviX9ka+v2MERkT8=
  file:
    - book.epub
    - book.mobi
    - book.pdf
  on:
    repo: GITenberg/The-Sea-Fairies_4358
    tags: true
addons:
  apt:
    packages:
    - xsltproc
    - xvfb
    - calibre
    - python-pip
    - git
    - python-dev
    - libjpeg-dev
    - libpng-dev
    - libfreetype6
    - libfreetype6-dev
    - zlib1g-dev
    - python-lxml
    - libxml2-dev
    - libxslt1-dev
    - tidy